---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Admin">
  <div class="text-center mb-8">
    <h1 class="text-4xl font-extrabold">
      <span class="text-yellow-300">ðŸŽ­</span> <span class="text-red-400">Admin</span>
    </h1>
  </div>

  <!-- Add Person Form -->
  <form id="add-form" class="flex gap-2 mb-8">
    <input
      type="text"
      id="name-input"
      placeholder="Name eingeben"
      required
      class="flex-1 px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-yellow-200/40 focus:outline-none focus:border-yellow-400 backdrop-blur-sm"
    />
    <button
      type="submit"
      class="bg-yellow-400 text-purple-900 font-bold px-6 py-3 rounded-xl hover:bg-yellow-300 transition-colors"
    >
      HinzufÃ¼gen
    </button>
  </form>

  <!-- Person List -->
  <div id="persons-list" class="space-y-3">
    <p class="text-yellow-200/50 text-center">Lade Personen...</p>
  </div>

  <script is:inline>
    var form = document.getElementById("add-form");
    var nameInput = document.getElementById("name-input");
    var list = document.getElementById("persons-list");

    async function loadPersons() {
      try {
        var res = await fetch("/api/persons");
        var persons = await res.json();

        if (persons.length === 0) {
          list.innerHTML = '<p class="text-yellow-200/50 text-center">Noch keine Personen vorhanden.</p>';
          return;
        }

        list.innerHTML = persons
          .map(function (p) {
            return (
              '<div class="flex items-center justify-between rounded-xl px-5 py-4 border border-white/10 bg-white/5 backdrop-blur-sm">' +
              "<div>" +
              '<span class="font-bold text-lg">' + p.name + "</span>" +
              '<span class="text-yellow-300/60 ml-2">(' + p.score + " Punkte)</span>" +
              "</div>" +
              '<div class="flex gap-2">' +
              '<a href="/api/persons/' + p.id + '/qrcode" download="qr-' + p.name + '.png" ' +
              'class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-400 transition-colors text-sm font-bold">' +
              "QR-Code</a>" +
              '<button data-delete-id="' + p.id + '" ' +
              'class="bg-red-500/80 text-white px-4 py-2 rounded-lg hover:bg-red-400 transition-colors text-sm font-bold">' +
              "LÃ¶schen</button>" +
              "</div></div>"
            );
          })
          .join("");

        list.querySelectorAll("[data-delete-id]").forEach(function (btn) {
          btn.addEventListener("click", async function () {
            var id = btn.dataset.deleteId;
            if (!confirm("Person wirklich lÃ¶schen?")) return;
            await fetch("/api/persons/" + id, { method: "DELETE" });
            loadPersons();
          });
        });
      } catch (e) {
        list.innerHTML = '<p class="text-red-300 text-center">Fehler beim Laden der Personen.</p>';
      }
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      var name = nameInput.value.trim();
      if (!name) return;

      await fetch("/api/persons", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name }),
      });

      nameInput.value = "";
      loadPersons();
    });

    loadPersons();
  </script>
</Layout>
