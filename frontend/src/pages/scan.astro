---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Punkt vergeben">
  <div id="scan-result" class="text-center py-12">
    <p class="text-yellow-200/50 text-lg">Punkt wird vergeben...</p>
  </div>

  <script is:inline>
    var id = window.location.pathname.split("/").filter(Boolean).pop();
    var container = document.getElementById("scan-result");

    function getScannedIds() {
      try {
        return JSON.parse(localStorage.getItem("scannedIds") || "[]");
      } catch (e) {
        return [];
      }
    }

    function markAsScanned(personId) {
      var ids = getScannedIds();
      if (ids.indexOf(personId) === -1) {
        ids.push(personId);
        localStorage.setItem("scannedIds", JSON.stringify(ids));
      }
    }

    function showAlreadyScanned(name) {
      container.innerHTML =
        '<p class="text-6xl mb-4">ðŸš«</p>' +
        '<p class="text-orange-300 text-3xl font-extrabold mb-3">Bereits gescannt!</p>' +
        '<p class="text-xl mb-1">Du hast den QR-Code' + (name ? ' von <span class="font-bold text-yellow-300">' + name + '</span>' : '') + ' bereits gescannt.</p>' +
        '<p class="text-yellow-200/60 text-base mt-2 mb-6">Jeder QR-Code kann nur einmal pro Person gescannt werden.</p>' +
        '<a href="/" class="inline-block bg-yellow-400 text-purple-900 font-bold px-8 py-3 rounded-xl hover:bg-yellow-300 transition-colors text-lg">Zum Scoreboard</a>';
    }

    async function scan() {
      if (!id || isNaN(Number(id))) {
        container.innerHTML =
          '<p class="text-red-300 text-xl font-bold">UngÃ¼ltiger QR-Code!</p>' +
          '<a href="/" class="mt-4 inline-block text-yellow-300 hover:underline">Zum Scoreboard</a>';
        return;
      }

      // Client-side check: already scanned?
      if (getScannedIds().indexOf(id) !== -1) {
        showAlreadyScanned();
        return;
      }

      try {
        var res = await fetch("/api/scan/" + id, { method: "POST" });

        if (res.status === 409) {
          var errData = await res.json();
          markAsScanned(id);
          showAlreadyScanned(errData.name);
          return;
        }

        if (!res.ok) {
          container.innerHTML =
            '<p class="text-red-300 text-xl font-bold">Person nicht gefunden!</p>' +
            '<a href="/" class="mt-4 inline-block text-yellow-300 hover:underline">Zum Scoreboard</a>';
          return;
        }

        var data = await res.json();
        markAsScanned(id);
        container.innerHTML =
          '<p class="text-6xl mb-4">ðŸŽŠ</p>' +
          '<p class="text-green-300 text-3xl font-extrabold mb-3">+1 Punkt!</p>' +
          '<p class="text-xl mb-1">Punkt fÃ¼r <span class="font-bold text-yellow-300">' + data.name + '</span> vergeben!</p>' +
          '<p class="text-5xl font-extrabold text-yellow-300 my-6">' + data.score + ' Punkte</p>' +
          '<a href="/" class="inline-block bg-yellow-400 text-purple-900 font-bold px-8 py-3 rounded-xl hover:bg-yellow-300 transition-colors text-lg">Zum Scoreboard</a>' +
          '<p class="text-yellow-200/40 text-sm mt-4">Weiterleitung in 5 Sekunden...</p>';

        setTimeout(function () {
          window.location.href = "/";
        }, 5000);
      } catch (e) {
        container.innerHTML =
          '<p class="text-red-300 text-xl font-bold">Fehler beim Vergeben des Punktes.</p>' +
          '<a href="/" class="mt-4 inline-block text-yellow-300 hover:underline">Zum Scoreboard</a>';
      }
    }

    scan();
  </script>
</Layout>
